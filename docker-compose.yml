services:
  postgres:
    image: postgres:16
    container_name: local-postgres-new
    environment:
      POSTGRES_USER: ${PGUSER}
      POSTGRES_PASSWORD: ${PGPASSWORD}
      POSTGRES_DB: ${WAREHOUSE_DB}
    ports:
      - "${PGPORT}:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data

  lightdash:
    image: lightdash/lightdash:latest
    platform: linux/amd64
    container_name: lightdash
    depends_on:
      - postgres
    ports:
      - "${LD_PORT:-8080}:8080"
    environment:
      # Lightdash metadata database (NOT your analytics data)
      PGHOST: postgres
      PGPORT: 5432
      PGUSER: ${PGUSER}
      PGPASSWORD: ${PGPASSWORD}
      PGDATABASE: ${LIGHTDASH_META_DB}
      LIGHTDASH_SECRET: ${LIGHTDASH_SECRET}
      NODE_ENV: production
      SECURE_COOKIES: "false"
      TRUST_PROXY: "false"
      LIGHTDASH_LOG_LEVEL: info
      SCHEDULER_ENABLED: "true"
      # If you later add the optional headless browser, uncomment:
      # HEADLESS_BROWSER_HOST: headless-browser
      # HEADLESS_BROWSER_PORT: 3000

      S3_ENDPOINT: "http://minio:9000"        # or your host/ip
      S3_BUCKET: "lightdash"
      S3_REGION: "us-east-1"
      S3_ACCESS_KEY: ${S3_ACCESS_KEY}         # or your MINIO_ROOT_USER
      S3_SECRET_KEY: ${S3_SECRET_KEY}         # or your MINIO_ROOT_PASSWORD
      S3_FORCE_PATH_STYLE: "true"             # REQUIRED for MinIO

    volumes:
      # Mount your dbt project (folder that contains dbt_project.yml)
      - "${DBT_PROJECT_DIR}:/usr/app/dbt:ro"

  # Optional: headless browser for scheduled deliveries/exports
  # headless-browser:
  #   image: ghcr.io/browserless/chromium:v2.24.3
  #   container_name: lightdash-headless
  #   restart: unless-stopped
  #   ports:
  #     - "3001:3000"

  # Optional: MinIO (S3-compatible) for result cache/exports
  # minio:
  #   image: bitnami/minio:latest
  #   container_name: lightdash-minio
  #   environment:
  #     MINIO_ROOT_USER: minioadmin
  #     MINIO_ROOT_PASSWORD: minioadmin
  #     MINIO_DEFAULT_BUCKETS: default
  #   ports:
  #     - "9000:9000"
  #     - "9001:9001"

#exteral storage for lightdash to use (to fix pagination error because Postgres does not support)
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: secret123
    volumes:
      - ./minio-data:/data
    ports:
      - "9000:9000"  # S3 API
      - "9001:9001"  # Web console
    restart: unless-stopped

volumes:
  pgdata:
# docker-compose.yml

